# ==============================================================================
# Veridis Decentralized Identity Protocol - HashiCorp Vault ServiceMonitor
# ==============================================================================
#
# This manifest defines comprehensive HashiCorp Vault ServiceMonitor configurations for the
# Veridis deployment, providing:
#
# ENTERPRISE VAULT MONITORING ARCHITECTURE:
#   • Advanced ServiceMonitor orchestration with comprehensive metrics collection and analysis
#   • Multi-tier monitoring architecture with operational metrics, security metrics, and business intelligence
#   • Comprehensive monitoring security with TLS encryption, authentication, and access controls
#   • Advanced monitoring lifecycle management with automated discovery, scaling, and optimization
#   • Enterprise-grade monitoring intelligence with comprehensive analytics and performance insights
#
# VAULT MONITORING PERFORMANCE OPTIMIZATION:
#   • High-performance metrics collection with intelligent sampling and aggregation systems
#   • Intelligent monitoring tiering with real-time, near-real-time, and batch analytics
#   • Advanced monitoring replication with distributed collection and centralized analysis
#   • Comprehensive monitoring compression with intelligent algorithms and storage optimization
#   • Enterprise monitoring deduplication with advanced algorithms and efficiency optimization
#
# COMPLIANCE FRAMEWORK INTEGRATION:
#   • SOC 2 Type II monitoring controls with comprehensive audit and metrics requirements
#   • GDPR monitoring compliance with data protection, privacy metrics, and deletion procedures
#   • ISO 27001 monitoring security management with comprehensive framework integration
#   • PCI DSS monitoring requirements for cardholder data environment protection and validation
#   • FIPS 140-2 Level 3 monitoring encryption with validated cryptographic modules and procedures
#
# ENTERPRISE OPERATIONAL EXCELLENCE:
#   • Intelligent monitoring lifecycle management with automated provisioning and optimization
#   • Predictive monitoring analytics with capacity planning and performance intelligence
#   • Advanced alerting integration with monitoring analytics and business intelligence
#   • Comprehensive monitoring backup and recovery with disaster preparedness procedures
#   • Business continuity monitoring with failover capabilities and redundancy optimization
#
# VAULT BUSINESS INTELLIGENCE:
#   • Monitoring usage analytics with capacity planning and optimization recommendations
#   • Performance monitoring with latency analysis and throughput optimization intelligence
#   • Security monitoring with access analytics and anomaly detection capabilities
#   • Cost optimization with monitoring efficiency analysis and capacity planning procedures
#   • Compliance monitoring with audit trails and validation procedures
#
# ==============================================================================

# ==============================================================================
# Vault Primary ServiceMonitor - Comprehensive Operational Metrics
# ==============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vault-primary-metrics
  namespace: veridis-secrets

  # Core Vault ServiceMonitor identification labels
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/instance: veridis-production
    app.kubernetes.io/version: "1.15.6"
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: veridis-protocol
    app.kubernetes.io/managed-by: kustomize

    # ServiceMonitor specific classification
    monitoring.veridis.xyz/type: operational-metrics
    monitoring.veridis.xyz/tier: enterprise
    monitoring.veridis.xyz/role: vault-primary-monitoring
    monitoring.veridis.xyz/security-level: high
    monitoring.veridis.xyz/collection-frequency: high

    # Metrics classification
    metrics.veridis.xyz/category: operational
    metrics.veridis.xyz/collection-method: pull
    metrics.veridis.xyz/format: prometheus
    metrics.veridis.xyz/retention-period: "90d"
    metrics.veridis.xyz/aggregation-level: detailed

    # Performance monitoring classification
    performance.veridis.xyz/latency-monitoring: enabled
    performance.veridis.xyz/throughput-monitoring: enabled
    performance.veridis.xyz/resource-monitoring: comprehensive
    performance.veridis.xyz/error-monitoring: detailed
    performance.veridis.xyz/saturation-monitoring: enabled

    # Security monitoring classification
    security.veridis.xyz/access-monitoring: comprehensive
    security.veridis.xyz/audit-monitoring: enabled
    security.veridis.xyz/tls-monitoring: required
    security.veridis.xyz/auth-monitoring: detailed
    security.veridis.xyz/threat-monitoring: enabled

    # Business monitoring classification
    business.veridis.xyz/criticality: mission-critical
    business.veridis.xyz/impact: operational-visibility
    business.veridis.xyz/cost-tier: standard
    business.veridis.xyz/sla-tier: high
    business.veridis.xyz/availability-requirement: maximum

    # Operational monitoring labels
    veridis.xyz/environment: production
    veridis.xyz/team: security-engineering
    veridis.xyz/cost-center: security-infrastructure
    veridis.xyz/business-unit: identity-protocol

    # Compliance framework labels
    compliance.veridis.xyz/soc2: "monitoring-control-framework"
    compliance.veridis.xyz/gdpr: "monitoring-data-protection"
    compliance.veridis.xyz/iso27001: "monitoring-security-management"
    compliance.veridis.xyz/pci-dss: "monitoring-security-requirements"
    compliance.veridis.xyz/fips-140-2: "monitoring-encryption-validation"
    governance.veridis.xyz/policy-enforcement: "strict"

    # Monitoring analytics and intelligence
    analytics.veridis.xyz/metrics-analytics: "enabled"
    analytics.veridis.xyz/performance-analytics: "comprehensive"
    analytics.veridis.xyz/security-analytics: "detailed"
    analytics.veridis.xyz/business-analytics: "enabled"
    analytics.veridis.xyz/predictive-analytics: "enabled"

  annotations:
    # ServiceMonitor purpose and specifications
    veridis.xyz/description: "Enterprise primary ServiceMonitor for Vault with comprehensive operational metrics and analytics"
    veridis.xyz/purpose: "Provides comprehensive operational metrics collection for Vault with performance and security monitoring"
    veridis.xyz/scope: "Primary metrics including performance, security, operational, and business intelligence metrics"

    # Monitoring architecture and design
    monitoring.veridis.xyz/architecture: "Enterprise monitoring with comprehensive metrics collection, analytics, and intelligence"
    monitoring.veridis.xyz/design-pattern: "Multi-tier monitoring with real-time, near-real-time, and batch analytics capabilities"
    monitoring.veridis.xyz/security-model: "Secure monitoring with TLS encryption, authentication, and access controls"
    monitoring.veridis.xyz/performance-model: "High-performance monitoring with intelligent sampling and aggregation"

    # Metrics collection specifications
    metrics.veridis.xyz/collection-specification: "Comprehensive metrics collection with intelligent sampling and aggregation"
    metrics.veridis.xyz/retention-specification: "90-day retention with intelligent tiering and archival procedures"
    metrics.veridis.xyz/aggregation-specification: "Multi-level aggregation with real-time and batch processing"
    metrics.veridis.xyz/compression-specification: "Intelligent compression with storage optimization and efficiency"

    # Performance monitoring specifications
    performance.veridis.xyz/latency-specification: "Comprehensive latency monitoring with P50, P95, P99 percentiles and optimization"
    performance.veridis.xyz/throughput-specification: "Throughput monitoring with capacity analysis and optimization recommendations"
    performance.veridis.xyz/resource-specification: "Resource monitoring with CPU, memory, storage, and network analytics"
    performance.veridis.xyz/error-specification: "Error monitoring with categorization, analysis, and alerting procedures"

    # Security monitoring specifications
    security.veridis.xyz/access-specification: "Access monitoring with authentication, authorization, and audit analytics"
    security.veridis.xyz/threat-specification: "Threat monitoring with anomaly detection and security intelligence"
    security.veridis.xyz/audit-specification: "Audit monitoring with comprehensive logging and compliance validation"
    security.veridis.xyz/encryption-specification: "Encryption monitoring with key usage and rotation analytics"

    # Business monitoring specifications
    business.veridis.xyz/sla-specification: "SLA monitoring with availability, performance, and reliability analytics"
    business.veridis.xyz/cost-specification: "Cost monitoring with resource utilization and efficiency analysis"
    business.veridis.xyz/capacity-specification: "Capacity monitoring with planning and optimization recommendations"
    business.veridis.xyz/compliance-specification: "Compliance monitoring with regulatory validation and reporting"

    # Operational monitoring specifications
    operations.veridis.xyz/automation-specification: "Automated monitoring with intelligent management and optimization"
    operations.veridis.xyz/alerting-specification: "Comprehensive alerting with escalation and automated response"
    operations.veridis.xyz/dashboard-specification: "Interactive dashboards with real-time analytics and intelligence"
    operations.veridis.xyz/reporting-specification: "Automated reporting with business intelligence and optimization"

    # Analytics and intelligence specifications
    analytics.veridis.xyz/performance-analytics: "Performance analytics with optimization recommendations and intelligence"
    analytics.veridis.xyz/security-analytics: "Security analytics with threat intelligence and anomaly detection"
    analytics.veridis.xyz/business-analytics: "Business analytics with cost optimization and capacity planning"
    analytics.veridis.xyz/predictive-analytics: "Predictive analytics with forecasting and optimization recommendations"

    # Documentation and procedures
    veridis.xyz/owner: "security-team@veridis.xyz"
    veridis.xyz/monitoring-admin: "vault-monitoring-admin@veridis.xyz"
    veridis.xyz/escalation: "security-manager@veridis.xyz"
    veridis.xyz/emergency-contact: "security-oncall@veridis.xyz"

    # Documentation references
    veridis.xyz/documentation: "https://docs.veridis.xyz/infrastructure/vault/primary-monitoring"
    veridis.xyz/runbook: "https://runbooks.veridis.xyz/vault/monitoring-management"
    veridis.xyz/security-docs: "https://security.veridis.xyz/vault/monitoring-security"
    veridis.xyz/compliance-docs: "https://compliance.veridis.xyz/vault/monitoring-compliance"

    # Prometheus ServiceMonitor annotations
    prometheus.io/scrape: "true"
    prometheus.io/path: "/v1/sys/metrics"
    prometheus.io/port: "8200"
    prometheus.io/scheme: "https"

spec:
  # ==============================================================================
  # Service Selector Configuration
  # ==============================================================================
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
      app.kubernetes.io/instance: veridis-production
      app.kubernetes.io/component: server
      monitoring.veridis.xyz/enabled: "true"

  # Namespace selector for cross-namespace monitoring
  namespaceSelector:
    matchNames:
      - veridis-secrets
      - veridis-vault
      - veridis-monitoring

  # ==============================================================================
  # Endpoint Configuration - Primary Metrics Collection
  # ==============================================================================
  endpoints:
    # Primary operational metrics endpoint
    - port: vault-metrics
      path: /v1/sys/metrics
      scheme: https
      interval: 30s
      scrapeTimeout: 25s
      honorLabels: true
      honorTimestamps: true

      # TLS configuration for secure metrics collection
      tlsConfig:
        # Server certificate validation
        ca:
          secret:
            name: vault-tls-certificates
            key: ca.crt
        cert:
          secret:
            name: vault-monitoring-certificates
            key: tls.crt
        keySecret:
          name: vault-monitoring-certificates
          key: tls.key

        # TLS security configuration
        serverName: vault.veridis-secrets.svc.cluster.local
        insecureSkipVerify: false
        minVersion: "TLS13"
        maxVersion: "TLS13"

      # Authentication configuration
      authorization:
        type: Bearer
        credentials:
          name: vault-monitoring-secrets
          key: vault-token

      # HTTP client configuration
      followRedirects: true
      enableHttp2: true

      # Metrics filtering and labeling
      metricRelabelings:
        # Add environment label
        - sourceLabels: []
          targetLabel: environment
          replacement: production

        # Add cluster label
        - sourceLabels: []
          targetLabel: cluster
          replacement: veridis-production

        # Add region label
        - sourceLabels: []
          targetLabel: region
          replacement: us-east-1

        # Add availability zone from node
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: availability_zone
          regex: ".*-([a-z])$"
          replacement: "${1}"

        # Add pod information
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: vault_pod
          replacement: "${1}"

        # Add namespace information
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: vault_namespace
          replacement: "${1}"

        # Filter out high-cardinality metrics if needed
        - sourceLabels: [__name__]
          regex: "vault_audit_log_request_duration_.*"
          action: drop

      # Sample limit to prevent metric explosion
      sampleLimit: 10000
      targetLimit: 100

    # Health check metrics endpoint
    - port: vault-metrics
      path: /v1/sys/health
      scheme: https
      interval: 15s
      scrapeTimeout: 10s
      honorLabels: true

      # TLS configuration for health endpoint
      tlsConfig:
        ca:
          secret:
            name: vault-tls-certificates
            key: ca.crt
        serverName: vault.veridis-secrets.svc.cluster.local
        insecureSkipVerify: false

      # Health check specific labeling
      metricRelabelings:
        - sourceLabels: []
          targetLabel: endpoint_type
          replacement: health

        - sourceLabels: []
          targetLabel: check_frequency
          replacement: high

    # Performance metrics endpoint
    - port: vault-metrics
      path: /v1/sys/metrics
      scheme: https
      interval: 60s
      scrapeTimeout: 45s
      honorLabels: true

      # Query parameters for detailed metrics
      params:
        format: ['prometheus']
        detailed: ['true']

      # TLS configuration
      tlsConfig:
        ca:
          secret:
            name: vault-tls-certificates
            key: ca.crt
        cert:
          secret:
            name: vault-monitoring-certificates
            key: tls.crt
        keySecret:
          name: vault-monitoring-certificates
          key: tls.key
        serverName: vault.veridis-secrets.svc.cluster.local

      # Authentication for detailed metrics
      authorization:
        type: Bearer
        credentials:
          name: vault-monitoring-secrets
          key: vault-token

      # Performance metrics specific labeling
      metricRelabelings:
        - sourceLabels: []
          targetLabel: metrics_type
          replacement: performance

        - sourceLabels: []
          targetLabel: collection_frequency
          replacement: standard

        # Add performance tier labels
        - sourceLabels: [__name__]
          regex: "vault_core_.*"
          targetLabel: performance_tier
          replacement: core

        - sourceLabels: [__name__]
          regex: "vault_storage_.*"
          targetLabel: performance_tier
          replacement: storage

        - sourceLabels: [__name__]
          regex: "vault_audit_.*"
          targetLabel: performance_tier
          replacement: audit

---
# ==============================================================================
# Vault Security ServiceMonitor - Comprehensive Security Metrics
# ==============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vault-security-metrics
  namespace: veridis-secrets

  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/instance: veridis-production
    app.kubernetes.io/version: "1.15.6"
    app.kubernetes.io/component: security-monitoring
    app.kubernetes.io/part-of: veridis-protocol
    app.kubernetes.io/managed-by: kustomize

    monitoring.veridis.xyz/type: security-metrics
    monitoring.veridis.xyz/tier: enterprise
    monitoring.veridis.xyz/role: vault-security-monitoring
    monitoring.veridis.xyz/security-level: maximum
    monitoring.veridis.xyz/collection-frequency: high

    # Security metrics classification
    security.veridis.xyz/monitoring-type: comprehensive
    security.veridis.xyz/threat-detection: enabled
    security.veridis.xyz/anomaly-detection: enabled
    security.veridis.xyz/access-monitoring: detailed
    security.veridis.xyz/audit-monitoring: comprehensive

    # Compliance security monitoring
    compliance.veridis.xyz/soc2: "security-monitoring-control"
    compliance.veridis.xyz/gdpr: "security-data-protection"
    compliance.veridis.xyz/iso27001: "security-monitoring-management"
    compliance.veridis.xyz/pci-dss: "security-monitoring-requirements"
    governance.veridis.xyz/policy-enforcement: "maximum"

    # Security analytics and intelligence
    analytics.veridis.xyz/security-analytics: "enabled"
    analytics.veridis.xyz/threat-intelligence: "comprehensive"
    analytics.veridis.xyz/anomaly-analytics: "detailed"
    analytics.veridis.xyz/access-analytics: "enabled"

    veridis.xyz/environment: production
    veridis.xyz/team: security-engineering
    veridis.xyz/cost-center: security-infrastructure
    veridis.xyz/business-unit: identity-protocol

  annotations:
    veridis.xyz/description: "Enterprise security ServiceMonitor for Vault with comprehensive security metrics and threat detection"
    veridis.xyz/purpose: "Provides comprehensive security metrics collection for Vault with threat detection and anomaly analysis"
    veridis.xyz/scope: "Security metrics including access, audit, authentication, and threat detection analytics"

    monitoring.veridis.xyz/security-architecture: "Enterprise security monitoring with comprehensive threat detection and analytics"
    monitoring.veridis.xyz/threat-detection: "Multi-layer threat detection with machine learning and behavioral analysis"
    monitoring.veridis.xyz/anomaly-detection: "Advanced anomaly detection with statistical analysis and pattern recognition"
    monitoring.veridis.xyz/access-monitoring: "Comprehensive access monitoring with authentication and authorization analytics"

    veridis.xyz/owner: "security-team@veridis.xyz"
    veridis.xyz/security-admin: "vault-security-admin@veridis.xyz"
    veridis.xyz/documentation: "https://docs.veridis.xyz/infrastructure/vault/security-monitoring"

    prometheus.io/scrape: "true"
    prometheus.io/path: "/v1/sys/metrics"
    prometheus.io/security-metrics: "true"

spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
      app.kubernetes.io/instance: veridis-production
      security.veridis.xyz/monitoring: "enabled"

  namespaceSelector:
    matchNames:
      - veridis-secrets
      - veridis-security

  endpoints:
    # Security audit metrics endpoint
    - port: vault-metrics
      path: /v1/sys/metrics
      scheme: https
      interval: 15s
      scrapeTimeout: 12s
      honorLabels: true

      # Query parameters for security metrics
      params:
        format: ['prometheus']
        security: ['true']
        audit: ['true']

      # TLS configuration for security endpoint
      tlsConfig:
        ca:
          secret:
            name: vault-tls-certificates
            key: ca.crt
        cert:
          secret:
            name: vault-security-certificates
            key: tls.crt
        keySecret:
          name: vault-security-certificates
          key: tls.key
        serverName: vault.veridis-secrets.svc.cluster.local
        insecureSkipVerify: false
        minVersion: "TLS13"

      # Authentication for security metrics
      authorization:
        type: Bearer
        credentials:
          name: vault-security-secrets
          key: security-token

      # Security metrics specific labeling
      metricRelabelings:
        # Add security classification labels
        - sourceLabels: []
          targetLabel: security_tier
          replacement: maximum

        - sourceLabels: []
          targetLabel: monitoring_type
          replacement: security

        # Add threat detection labels
        - sourceLabels: [__name__]
          regex: "vault_audit_.*"
          targetLabel: security_category
          replacement: audit

        - sourceLabels: [__name__]
          regex: "vault_token_.*"
          targetLabel: security_category
          replacement: authentication

        - sourceLabels: [__name__]
          regex: "vault_policy_.*"
          targetLabel: security_category
          replacement: authorization

        # Add compliance labels
        - sourceLabels: []
          targetLabel: compliance_framework
          replacement: multi-framework

        - sourceLabels: []
          targetLabel: audit_required
          replacement: "true"

      sampleLimit: 15000
      targetLimit: 150

    # Access pattern monitoring endpoint
    - port: vault-metrics
      path: /v1/sys/metrics
      scheme: https
      interval: 30s
      scrapeTimeout: 25s

      params:
        format: ['prometheus']
        access_patterns: ['true']

      tlsConfig:
        ca:
          secret:
            name: vault-tls-certificates
            key: ca.crt
        cert:
          secret:
            name: vault-security-certificates
            key: tls.crt
        keySecret:
          name: vault-security-certificates
          key: tls.key
        serverName: vault.veridis-secrets.svc.cluster.local

      authorization:
        type: Bearer
        credentials:
          name: vault-security-secrets
          key: security-token

      metricRelabelings:
        - sourceLabels: []
          targetLabel: analysis_type
          replacement: access_patterns

        - sourceLabels: []
          targetLabel: detection_type
          replacement: behavioral

---
# ==============================================================================
# Vault Business Intelligence ServiceMonitor - Business Metrics
# ==============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vault-business-metrics
  namespace: veridis-secrets

  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/instance: veridis-production
    app.kubernetes.io/version: "1.15.6"
    app.kubernetes.io/component: business-monitoring
    app.kubernetes.io/part-of: veridis-protocol
    app.kubernetes.io/managed-by: kustomize

    monitoring.veridis.xyz/type: business-metrics
    monitoring.veridis.xyz/tier: enterprise
    monitoring.veridis.xyz/role: vault-business-monitoring
    monitoring.veridis.xyz/analytics-level: comprehensive
    monitoring.veridis.xyz/intelligence-level: advanced

    # Business metrics classification
    business.veridis.xyz/metrics-type: comprehensive
    business.veridis.xyz/analytics-enabled: "true"
    business.veridis.xyz/intelligence-enabled: "true"
    business.veridis.xyz/cost-monitoring: enabled
    business.veridis.xyz/sla-monitoring: enabled

    # Performance business monitoring
    performance.veridis.xyz/business-monitoring: enabled
    performance.veridis.xyz/capacity-monitoring: comprehensive
    performance.veridis.xyz/efficiency-monitoring: detailed
    performance.veridis.xyz/optimization-monitoring: enabled

    # Analytics and intelligence
    analytics.veridis.xyz/business-analytics: "enabled"
    analytics.veridis.xyz/cost-analytics: "comprehensive"
    analytics.veridis.xyz/capacity-analytics: "detailed"
    analytics.veridis.xyz/efficiency-analytics: "enabled"

    veridis.xyz/environment: production
    veridis.xyz/team: security-engineering
    veridis.xyz/cost-center: security-infrastructure
    veridis.xyz/business-unit: identity-protocol

  annotations:
    veridis.xyz/description: "Enterprise business ServiceMonitor for Vault with comprehensive business intelligence and analytics"
    veridis.xyz/purpose: "Provides comprehensive business metrics collection for Vault with cost optimization and capacity planning"
    veridis.xyz/scope: "Business metrics including cost, capacity, efficiency, and optimization analytics"

    monitoring.veridis.xyz/business-architecture: "Enterprise business monitoring with comprehensive analytics and intelligence"
    monitoring.veridis.xyz/cost-optimization: "Advanced cost optimization with efficiency analysis and recommendations"
    monitoring.veridis.xyz/capacity-planning: "Intelligent capacity planning with predictive analytics and optimization"
    monitoring.veridis.xyz/efficiency-analysis: "Comprehensive efficiency analysis with optimization recommendations"

    veridis.xyz/owner: "security-team@veridis.xyz"
    veridis.xyz/business-admin: "vault-business-admin@veridis.xyz"
    veridis.xyz/documentation: "https://docs.veridis.xyz/infrastructure/vault/business-monitoring"

    prometheus.io/scrape: "true"
    prometheus.io/business-metrics: "true"

spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
      app.kubernetes.io/instance: veridis-production
      business.veridis.xyz/monitoring: "enabled"

  namespaceSelector:
    matchNames:
      - veridis-secrets
      - veridis-business

  endpoints:
    # Business performance metrics endpoint
    - port: vault-metrics
      path: /v1/sys/metrics
      scheme: https
      interval: 120s
      scrapeTimeout: 90s
      honorLabels: true

      params:
        format: ['prometheus']
        business: ['true']
        analytics: ['true']

      tlsConfig:
        ca:
          secret:
            name: vault-tls-certificates
            key: ca.crt
        cert:
          secret:
            name: vault-business-certificates
            key: tls.crt
        keySecret:
          name: vault-business-certificates
          key: tls.key
        serverName: vault.veridis-secrets.svc.cluster.local

      authorization:
        type: Bearer
        credentials:
          name: vault-business-secrets
          key: business-token

      metricRelabelings:
        # Add business classification labels
        - sourceLabels: []
          targetLabel: business_tier
          replacement: enterprise

        - sourceLabels: []
          targetLabel: analytics_type
          replacement: business

        # Add cost optimization labels
        - sourceLabels: [__name__]
          regex: "vault_storage_.*"
          targetLabel: cost_category
          replacement: storage

        - sourceLabels: [__name__]
          regex: "vault_core_.*"
          targetLabel: cost_category
          replacement: compute

        # Add capacity planning labels
        - sourceLabels: []
          targetLabel: capacity_planning
          replacement: enabled

        - sourceLabels: []
          targetLabel: optimization_level
          replacement: comprehensive

      sampleLimit: 5000
      targetLimit: 50

---
# ==============================================================================
# Vault HSM ServiceMonitor - Hardware Security Module Metrics
# ==============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vault-hsm-metrics
  namespace: veridis-secrets

  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/instance: veridis-production
    app.kubernetes.io/version: "1.15.6"
    app.kubernetes.io/component: hsm-monitoring
    app.kubernetes.io/part-of: veridis-protocol
    app.kubernetes.io/managed-by: kustomize

    monitoring.veridis.xyz/type: hsm-metrics
    monitoring.veridis.xyz/tier: enterprise
    monitoring.veridis.xyz/role: vault-hsm-monitoring
    monitoring.veridis.xyz/security-level: maximum
    monitoring.veridis.xyz/hsm-integration: enabled

    # HSM metrics classification
    hsm.veridis.xyz/monitoring-type: comprehensive
    hsm.veridis.xyz/performance-monitoring: enabled
    hsm.veridis.xyz/security-monitoring: maximum
    hsm.veridis.xyz/health-monitoring: continuous
    hsm.veridis.xyz/compliance-monitoring: fips-140-2

    # Security HSM monitoring
    security.veridis.xyz/hsm-security: maximum
    security.veridis.xyz/tamper-monitoring: enabled
    security.veridis.xyz/key-monitoring: comprehensive
    security.veridis.xyz/crypto-monitoring: detailed

    # Compliance HSM monitoring
    compliance.veridis.xyz/fips-140-2: "level-3-monitoring"
    compliance.veridis.xyz/common-criteria: "eal4-plus-monitoring"
    compliance.veridis.xyz/hsm-compliance: "comprehensive"

    veridis.xyz/environment: production
    veridis.xyz/team: security-engineering
    veridis.xyz/cost-center: security-infrastructure
    veridis.xyz/business-unit: identity-protocol

  annotations:
    veridis.xyz/description: "Enterprise HSM ServiceMonitor for Vault with comprehensive hardware security module monitoring"
    veridis.xyz/purpose: "Provides comprehensive HSM metrics collection for Vault with security and performance monitoring"
    veridis.xyz/scope: "HSM metrics including performance, security, health, and compliance monitoring"

    monitoring.veridis.xyz/hsm-architecture: "Enterprise HSM monitoring with comprehensive security and performance analytics"
    monitoring.veridis.xyz/tamper-monitoring: "Hardware tamper detection with automated response and alerting"
    monitoring.veridis.xyz/key-monitoring: "Comprehensive key lifecycle monitoring with usage analytics"
    monitoring.veridis.xyz/crypto-monitoring: "Cryptographic operation monitoring with performance optimization"

    veridis.xyz/owner: "security-team@veridis.xyz"
    veridis.xyz/hsm-admin: "vault-hsm-admin@veridis.xyz"
    veridis.xyz/documentation: "https://docs.veridis.xyz/infrastructure/vault/hsm-monitoring"

    prometheus.io/scrape: "true"
    prometheus.io/hsm-metrics: "true"

spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
      app.kubernetes.io/instance: veridis-production
      hsm.veridis.xyz/enabled: "true"

  namespaceSelector:
    matchNames:
      - veridis-secrets
      - veridis-hsm

  endpoints:
    # HSM performance metrics endpoint
    - port: vault-metrics
      path: /v1/sys/metrics
      scheme: https
      interval: 30s
      scrapeTimeout: 25s
      honorLabels: true

      params:
        format: ['prometheus']
        hsm: ['true']
        performance: ['true']

      tlsConfig:
        ca:
          secret:
            name: vault-tls-certificates
            key: ca.crt
        cert:
          secret:
            name: vault-hsm-certificates
            key: tls.crt
        keySecret:
          name: vault-hsm-certificates
          key: tls.key
        serverName: vault.veridis-secrets.svc.cluster.local

      authorization:
        type: Bearer
        credentials:
          name: vault-hsm-secrets
          key: hsm-token

      metricRelabelings:
        # Add HSM classification labels
        - sourceLabels: []
          targetLabel: hsm_tier
          replacement: enterprise

        - sourceLabels: []
          targetLabel: security_level
          replacement: maximum

        # Add compliance labels
        - sourceLabels: []
          targetLabel: fips_level
          replacement: "140-2-level-3"

        - sourceLabels: []
          targetLabel: common_criteria
          replacement: "eal4-plus"

        # Add HSM specific labels
        - sourceLabels: [__name__]
          regex: "vault_hsm_.*"
          targetLabel: hsm_component
          replacement: core

        - sourceLabels: [__name__]
          regex: "vault_pkcs11_.*"
          targetLabel: hsm_component
          replacement: pkcs11

      sampleLimit: 8000
      targetLimit: 80

---
# ==============================================================================
# Vault Backup ServiceMonitor - Backup and Recovery Metrics
# ==============================================================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: vault-backup-metrics
  namespace: veridis-secrets

  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/instance: veridis-production
    app.kubernetes.io/version: "1.15.6"
    app.kubernetes.io/component: backup-monitoring
    app.kubernetes.io/part-of: veridis-protocol
    app.kubernetes.io/managed-by: kustomize

    monitoring.veridis.xyz/type: backup-metrics
    monitoring.veridis.xyz/tier: enterprise
    monitoring.veridis.xyz/role: vault-backup-monitoring
    monitoring.veridis.xyz/recovery-monitoring: enabled
    monitoring.veridis.xyz/disaster-recovery: enabled

    # Backup metrics classification
    backup.veridis.xyz/monitoring-type: comprehensive
    backup.veridis.xyz/recovery-monitoring: enabled
    backup.veridis.xyz/disaster-monitoring: enabled
    backup.veridis.xyz/continuity-monitoring: enabled
    backup.veridis.xyz/integrity-monitoring: enabled

    # Recovery monitoring
    recovery.veridis.xyz/rto-monitoring: enabled
    recovery.veridis.xyz/rpo-monitoring: enabled
    recovery.veridis.xyz/testing-monitoring: automated
    recovery.veridis.xyz/validation-monitoring: comprehensive

    veridis.xyz/environment: production
    veridis.xyz/team: security-engineering
    veridis.xyz/cost-center: security-infrastructure
    veridis.xyz/business-unit: identity-protocol

  annotations:
    veridis.xyz/description: "Enterprise backup ServiceMonitor for Vault with comprehensive backup and recovery monitoring"
    veridis.xyz/purpose: "Provides comprehensive backup metrics collection for Vault with disaster recovery monitoring"
    veridis.xyz/scope: "Backup metrics including backup status, recovery metrics, and disaster recovery analytics"

    monitoring.veridis.xyz/backup-architecture: "Enterprise backup monitoring with comprehensive recovery analytics"
    monitoring.veridis.xyz/disaster-recovery: "Comprehensive disaster recovery monitoring with RTO/RPO analytics"
    monitoring.veridis.xyz/backup-validation: "Automated backup validation with integrity verification and testing"

    veridis.xyz/owner: "security-team@veridis.xyz"
    veridis.xyz/backup-admin: "vault-backup-admin@veridis.xyz"
    veridis.xyz/documentation: "https://docs.veridis.xyz/infrastructure/vault/backup-monitoring"

spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: vault
      app.kubernetes.io/instance: veridis-production
      backup.veridis.xyz/enabled: "true"

  namespaceSelector:
    matchNames:
      - veridis-secrets
      - veridis-backup

  endpoints:
    # Backup status metrics endpoint
    - port: vault-metrics
      path: /v1/sys/metrics
      scheme: https
      interval: 300s
      scrapeTimeout: 240s
      honorLabels: true

      params:
        format: ['prometheus']
        backup: ['true']
        recovery: ['true']

      tlsConfig:
        ca:
          secret:
            name: vault-tls-certificates
            key: ca.crt
        cert:
          secret:
            name: vault-backup-certificates
            key: tls.crt
        keySecret:
          name: vault-backup-certificates
          key: tls.key
        serverName: vault.veridis-secrets.svc.cluster.local

      authorization:
        type: Bearer
        credentials:
          name: vault-backup-secrets
          key: backup-token

      metricRelabelings:
        # Add backup classification labels
        - sourceLabels: []
          targetLabel: backup_tier
          replacement: enterprise

        - sourceLabels: []
          targetLabel: recovery_tier
          replacement: mission-critical

        # Add disaster recovery labels
        - sourceLabels: []
          targetLabel: disaster_recovery
          replacement: enabled

        - sourceLabels: []
          targetLabel: business_continuity
          replacement: maximum

      sampleLimit: 3000
      targetLimit: 30

# ==============================================================================
# Vault ServiceMonitor Summary and Enterprise Monitoring Architecture
# ==============================================================================
#
# COMPREHENSIVE VAULT MONITORING STRATEGY:
# ========================================
#
# VAULT SERVICEMONITOR ARCHITECTURE OVERVIEW:
# -------------------------------------------
# 1. Vault Primary ServiceMonitor (vault-primary-metrics):
#    - Enterprise operational metrics with comprehensive performance and resource monitoring
#    - 30-second collection interval with TLS security and authentication for real-time visibility
#    - Multi-endpoint configuration with health, performance, and operational metrics collection
#    - Intelligent metric filtering with relabeling and high-cardinality protection
#    - Comprehensive TLS configuration with certificate validation and secure communication
#
# 2. Vault Security ServiceMonitor (vault-security-metrics):
#    - Enterprise security metrics with threat detection and anomaly analysis capabilities
#    - 15-second collection interval for security-critical metrics with maximum security configuration
#    - Comprehensive audit monitoring with access patterns and behavioral analysis
#    - Advanced authentication with security tokens and comprehensive access controls
#    - Multi-layer threat detection with statistical analysis and pattern recognition
#
# 3. Vault Business Intelligence ServiceMonitor (vault-business-metrics):
#    - Enterprise business metrics with cost optimization and capacity planning analytics
#    - 120-second collection interval for business intelligence and strategic planning
#    - Comprehensive cost monitoring with efficiency analysis and optimization recommendations
#    - Advanced capacity planning with predictive analytics and resource optimization
#    - Business continuity monitoring with SLA tracking and performance guarantees
#
# 4. Vault HSM ServiceMonitor (vault-hsm-metrics):
#    - Enterprise HSM metrics with hardware security module monitoring and FIPS 140-2 compliance
#    - 30-second collection interval for HSM performance and security monitoring
#    - Comprehensive tamper detection with automated response and security alerting
#    - Advanced key lifecycle monitoring with usage analytics and rotation tracking
#    - FIPS 140-2 Level 3 compliance monitoring with validation and certification tracking
#
# 5. Vault Backup ServiceMonitor (vault-backup-metrics):
#    - Enterprise backup metrics with disaster recovery and business continuity monitoring
#    - 300-second collection interval for backup status and recovery analytics
#    - Comprehensive disaster recovery monitoring with RTO/RPO tracking and validation
#    - Automated backup validation with integrity verification and testing procedures
#    - Business continuity analytics with failover monitoring and recovery planning
#
# ENTERPRISE MONITORING FEATURES:
# ===============================
# Advanced Metrics Collection:
#   - Multi-tier collection with operational, security, business, HSM, and backup metrics
#   - Intelligent sampling with high-frequency security metrics and standard operational metrics
#   - Comprehensive TLS security with certificate validation and secure authentication
#   - Advanced filtering with metric relabeling and high-cardinality protection
#   - Performance optimization with sample limits and intelligent aggregation
#
# Security and Access Control:
#   - Maximum security configuration with TLS 1.3 encryption and certificate validation
#   - Fine-grained authentication with bearer tokens and comprehensive access controls
#   - Security-specific monitoring with threat detection and anomaly analysis
#   - Audit trail preservation with comprehensive logging and compliance validation
#   - HSM integration with hardware security module monitoring and validation
#
# Performance and Optimization:
#   - Intelligent collection intervals optimized for metric type and business requirements
#   - High-performance TLS configuration with HTTP/2 support and optimization
#   - Advanced metric filtering with relabeling and performance optimization
#   - Resource efficiency with sample limits and intelligent aggregation
#   - Performance analytics with latency monitoring and optimization recommendations
#
# Business Intelligence Integration:
#   - Comprehensive business metrics with cost optimization and capacity planning
#   - Advanced analytics with predictive capabilities and optimization recommendations
#   - Performance tracking with SLA monitoring and business intelligence
#   - Cost optimization with efficiency analysis and resource optimization
#   - Capacity planning with predictive analytics and strategic planning
#
# OPERATIONAL EXCELLENCE:
# ======================
# Monitoring Lifecycle Management:
#   - Automated service discovery with comprehensive label-based selection
#   - Intelligent metric collection with frequency optimization and resource efficiency
#   - Comprehensive health monitoring with multi-endpoint validation and testing
#   - Advanced alerting integration with escalation procedures and automated response
#   - Disaster recovery monitoring with business continuity and failover tracking
#
# Monitoring and Observability:
#   - Multi-tier monitoring with operational, security, business, and infrastructure metrics
#   - Real-time alerting with intelligent escalation and automated response procedures
#   - Performance monitoring with latency analysis and optimization recommendations
#   - Security monitoring with threat detection and anomaly analysis capabilities
#   - Business monitoring with cost optimization and capacity planning analytics
#
# Integration and Coordination:
#   - Prometheus native integration with comprehensive ServiceMonitor configuration
#   - Kubernetes service discovery with label-based selection and filtering
#   - TLS certificate integration with automated certificate management and validation
#   - Authentication integration with secure token management and access controls
#   - Monitoring ecosystem integration with Grafana, Alertmanager, and business intelligence
#
# Compliance and Governance:
#   - Multi-framework compliance with SOC 2, GDPR, ISO 27001, PCI DSS, and FIPS 140-2
#   - Automated compliance validation with policy enforcement and audit trails
#   - Security monitoring with comprehensive threat detection and validation
#   - Risk management with threat analysis and mitigation procedures
#   - Regulatory reporting with automated validation and evidence collection
#
# ==============================================================================
